############################################################################
# Test case for BUG#10780
#
# REQUIREMENT
#   A slave without replication privileges should have Slave_IO_Running = No
############################################################################
--source include/master-slave.inc

# 1. Create new replication user
--connection master
GRANT REPLICATION SLAVE ON *.* TO rpl@127.0.0.1 IDENTIFIED BY 'rpl';

--connection slave
STOP SLAVE;
--source include/wait_for_slave_to_stop.inc
CHANGE MASTER TO master_user='rpl',master_password='rpl';
START SLAVE;
--source include/wait_for_slave_to_start.inc

# 2. Do replication as new user
--connection master
--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings
CREATE TABLE t1 (n int);
INSERT INTO t1 VALUES (1);
--sync_slave_with_master
SELECT * FROM t1;

# 3. Delete new replication user
--connection master
DELETE FROM mysql.user WHERE user='rpl';
FLUSH PRIVILEGES;
--connection slave

# 4. Restart slave without privileges
# (slave.err will contain access denied error for this START SLAVE command)
STOP SLAVE;
--source include/wait_for_slave_to_stop.inc
START SLAVE;
--let $slave_param= Slave_SQL_Running
--let $slave_param_value= Yes
--source include/wait_for_slave_param.inc

# 5. Make sure Slave_IO_Running = No
--replace_result $MASTER_MYPORT MASTER_MYPORT
# Column 1 is replaced, since the output can be either
# "Connecting to master" or "Waiting for master update"
--replace_column 1 # 7 # 8 # 9 # 22 # 23 # 35 # 36 #
query_vertical SHOW SLAVE STATUS;

# Cleanup (Note that slave IO thread is not running)
--connection slave
DROP TABLE t1;
DELETE FROM mysql.user WHERE user='rpl';
# cleanup: slave io thread has been stopped "irrecoverably"
# so we clean up mess manually

--connection master
DROP TABLE t1;

# End of 4.1 tests
