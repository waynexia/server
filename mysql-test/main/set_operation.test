create table t1 (a int, b int) engine=MyISAM;
create table t2 (c int, d int) engine=MyISAM;
create table t3 (e int, f int) engine=MyISAM;
insert into t1 values (1,1),(2,2),(3,3),(2,2);
insert into t2 values (2,2),(3,3),(5,5);
insert into t3 values (4,4);
create view v0(g, h) as select a,c from t1,t2;

select * from t1
UNION ALL
select * from t2
INTERSECT ALL 
(values (1,1), (2,2), (2,2), (5,5), (2,2) order by 1)
INTERSECT ALL
select * from (select * from t1 union all select * from t1) sq
EXCEPT ALL
select * from t3
UNION ALL
select * from t2
UNION
select * from t3
EXCEPT 
select a,c from t1,t2
UNION ALL
select * from v0 where g < 4
UNION ALL 
select * from t3;

select * from (
    select * from t1
    UNION ALL
    select * from t2
    INTERSECT ALL 
    (values (1,1), (2,2), (2,2), (5,5), (2,2) order by 1)
    INTERSECT ALL
    select * from (select * from t1 union all select * from t1) sq
    EXCEPT ALL
    select * from t3
    UNION ALL
    select * from t2
    UNION
    select * from t3
    EXCEPT 
    select a,c from t1,t2
    UNION ALL
    select * from v0 where g < 4
    UNION ALL 
    select * from t3
) sq;

EXPLAIN
select * from t1
UNION ALL
select * from t2
INTERSECT ALL 
(values (1,1), (2,2), (2,2), (5,5), (2,2) order by 1)
INTERSECT ALL
select * from (select * from t1 union all select * from t1) sq
EXCEPT ALL
select * from t3
UNION ALL
select * from t2
UNION
select * from t3
EXCEPT 
select a,c from t1,t2
UNION ALL
select * from v0 where g < 4
UNION ALL 
select * from t3;

EXPLAIN format=json
select * from t1
UNION ALL
select * from t2
INTERSECT ALL 
(values (1,1), (2,2), (2,2), (5,5), (2,2) order by 1)
INTERSECT ALL
select * from (select * from t1 union all select * from t1) sq
EXCEPT ALL
select * from t3
UNION ALL
select * from t2
UNION
select * from t3
EXCEPT 
select a,c from t1,t2
UNION ALL
select * from v0 where g < 4
UNION ALL 
select * from t3;

EXPLAIN EXTENDED
select * from t1
UNION ALL
select * from t2
INTERSECT ALL 
(values (1,1), (2,2), (2,2), (5,5), (2,2) order by 1)
INTERSECT ALL
select * from (select * from t1 union all select * from t1) sq
EXCEPT ALL
select * from t3
UNION ALL
select * from t2
UNION
select * from t3
EXCEPT 
select a,c from t1,t2
UNION ALL
select * from v0 where g < 4
UNION ALL 
select * from t3;

PREPARE stmt from"
    select * from t1
    UNION ALL
    select * from t2
    INTERSECT ALL 
    (values (1,1), (2,2), (2,2), (5,5), (2,2) order by 1)
    INTERSECT ALL
    select * from (select * from t1 union all select * from t1) sq
    EXCEPT ALL
    select * from t3
    UNION ALL
    select * from t2
    UNION
    select * from t3
    EXCEPT 
    select a,c from t1,t2
    UNION ALL
    select * from v0 where g < 4
    UNION ALL 
    select * from t3
";

EXECUTE stmt;
EXECUTE stmt;
deallocate prepare stmt;

create view v1(i1, i2) as
    select * from t1
    UNION ALL
    select * from t2
    INTERSECT ALL 
    (values (1,1), (2,2), (2,2), (5,5), (2,2) order by 1)
    INTERSECT ALL
    select * from (select * from t1 union all select * from t1) sq
    EXCEPT ALL
    select * from t3
    UNION ALL
    select * from t2
    UNION
    select * from t3
    EXCEPT 
    select a,c from t1,t2
    UNION ALL
    select * from v0 where g < 4
    UNION ALL 
    select * from t3;

show create view v1;

select * from v1 limit 5;
--sorted_result
select * from v1 order by i1 limit 5;

let $q=
    select * from t1
    UNION ALL
    select * from t2
    INTERSECT ALL 
    (values (1,1), (2,2), (2,2), (5,5), (2,2) order by 1)
    INTERSECT ALL
    select * from (select * from t1 union all select * from t1) sq
    EXCEPT ALL
    select * from t3
    UNION ALL
    select * from t2
    UNION
    select * from t3
    EXCEPT 
    select a,c from t1,t2
    UNION ALL
    select * from v0 where g < 4
    UNION ALL 
    select * from t3;

eval $q;
eval EXPLAIN EXTENDED $q;

drop table t1,t2,t3;
drop view v0,v1;

#
# test of optimize bag operation
#

create table t1 (a int, b int);
create table t2 (c int, d int);
create table t3 (e int, f int);
create table t4 (g int, h int);


insert into t1 values (1,1),(1,1),(2,2);
insert into t2 values (1,1),(1,1),(2,2),(3,3);
insert into t3 values (1,1);
insert into t4 values (4,4);

select * from t1 intersect all select * from t2 except select * from t3 union select * from t4;
select * from t1 intersect all select * from t2 except ALL select * from t3 union select * from t4;

select * from t1 intersect DISTINCT select * from t2 except select * from t3 union select * from t4;
select * from t1 intersect DISTINCT select * from t2 except ALL select * from t3 union select * from t4;

delete from t1 where true;
delete from t2 where true;
delete from t3 where true;
delete from t4 where true;


insert into t1 values (1,1),(1,1),(1,1),(2,2),(2,2),(4,4);
insert into t2 values (1,1),(1,1),(1,1),(2,2),(2,2),(3,3);
insert into t3 values (1,1),(2,2),(2,2);

select * from t1 intersect all select * from t2 intersect all select * from t3;
select * from t1 intersect all select * from t2 intersect select * from t3;
select * from t1 intersect all select * from t1 intersect all select * from t2 intersect select * from t3;

delete from t1 where true;
delete from t2 where true;
delete from t3 where true;


insert into t1 values (1,1),(1,1),(2,2);
insert into t2 values (1,1),(1,1),(2,2),(3,3);
insert into t3 values (1,1),(5,5);
insert into t4 values (4,4),(4,4),(4,4);

select * from t1 intersect all select * from t2 union all select * from t3 union select * from t4;
select * from t1 intersect DISTINCT select * from t2 union DISTINCT select * from t3 union select * from t4;

select * from t1 intersect all select * from t2 intersect all select * from t3 union select * from t4;
select * from t1 intersect all select * from t2 intersect DISTINCT select * from t3 union select * from t4;
select * from t1 intersect DISTINCT select * from t2 intersect DISTINCT select * from t3 union select * from t4;

select * from t1 intersect all select * from t2 EXCEPT select * from t3 union select * from t4;
select * from t1 intersect DISTINCT select * from t2 EXCEPT select * from t3 union select * from t4;
select * from t1 intersect all select * from t2 EXCEPT ALL select * from t3 union select * from t4;

select * from t1 EXCEPT select * from t2 union all select * from t3 union select * from t4;
select * from t1 EXCEPT select * from t2 union DISTINCT select * from t3 union select * from t4;

delete from t1 where true;
delete from t2 where true;
delete from t3 where true;
delete from t4 where true;


insert into t1 values (1,1),(2,2);
insert into t2 values (1,1),(2,2);
insert into t3 values (1,1),(3,3);

select * from t1 union all select * from t2 except all select * from t3;
select * from t1 union all select * from t2 except DISTINCT select * from t3;
select * from t1 union DISTINCT select * from t2 except all select * from t3;
select * from t1 union DISTINCT select * from t2 except DISTINCT select * from t3;

drop table t1;
drop table t2;
drop table t3;
drop table t4;


select 1 intersect all select 2 intersect all select 3 intersect select 4 union select 5;
select 1 intersect all select 2 intersect all select 3 union select 4 except select 5;
select 1 union select 2 except all select 3 union select 4;
select 1 union all select 2 union all select 3 union select 4;