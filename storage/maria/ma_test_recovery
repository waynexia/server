set -e
silent="-s"
if [ -z "$maria_path" ]
then
    maria_path="."
fi

echo "MARIA RECOVERY TESTS - success is if exit code is 0"

# runs a program inserting/deleting rows, then moves the resulting table
# elsewhere; applies the log and checks that the data file is
# identical to the saved original.
# Does not test the index file as we don't have logging for it yet.

for prog in "$maria_path/ma_test1 $silent -M -T --skip-update -c" "$maria_path/ma_test2 $silent -L -K -W -P -M -T -g -c"
do
  rm -f maria_log*
  echo "TEST WITH $prog"
  $prog
  # derive table's name from program's name
  table=`echo $prog | sed -e 's;.*ma_\(test[0-9]\).*;\1;' `
  $maria_path/maria_chk -dvv $table > maria_chk_message.good.txt 2>&1
  mv -f $table.MAD $table.MAD.good
  rm $table.MAI
  echo "applying log"
  $maria_path/maria_read_log -a > maria_read_log_$table.txt
  cmp $table.MAD $table.MAD.good
  $maria_path/maria_chk -dvv $table > maria_chk_message.txt 2>&1
# When "recovery of the table's state" is ready, we can test it like this:
#  diff maria_chk_message.good.txt maria_chk_message.txt >maria_chk_diff.txt || true
#  if [ -s maria_chk_diff.txt ]
#      then
#      echo "Differences in maria_chk -dvv, recovery not yet perfect !"
#      echo "========DIFF START======="
#      cat maria_chk_diff.txt
#      echo "========DIFF END======="
#  fi
  rm -f $table.* maria_chk_*.txt maria_read_log_$table.txt
done

echo "ALL RECOVERY TESTS OK"
